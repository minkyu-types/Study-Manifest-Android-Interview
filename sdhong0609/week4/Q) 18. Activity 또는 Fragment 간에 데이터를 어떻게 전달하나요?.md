## Q) 18. Activity ë˜ëŠ” Fragment ê°„ì— ë°ì´í„°ë¥¼ ì–´ë–»ê²Œ ì „ë‹¬í•˜ë‚˜ìš”?

### Activity ê°„ ë°ì´í„° ì „ë‹¬

- Activity ê°„ ë°ì´ì € ì „ë‹¬ì˜ ê°€ì¥ ì¼ë°˜ì ì¸ ë©”ì»¤ë‹ˆì¦˜ì€ Intent
- ë°ì´í„°ëŠ” í‚¤-ê°’ ìŒ(putExtra())ì˜ í˜•íƒœë¡œ Intentì— ì¶”ê°€ë˜ê³ , ìˆ˜ì‹ í•˜ëŠ” ActivityëŠ” getIntent()ë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ ê°’ì„ ê°€ì ¸ì˜¨ë‹¤.

```kotlin
// ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ëŠ” Activity
val intent = Intent(this, SecondActivity::class.java).apply {
    putExtra("USER_NAME", "John Doe")
    putExtra("USER_AGE", 25)
}
startActivity(intent)

// ë°ì´í„°ë¥¼ ìˆ˜ì‹ í•˜ëŠ” Activity
class SecondActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_second)

        val userName = intent.getStringExtra("USER_NAME")
        val userAge = intent.getIntExtra("USER_AGE", 0)
        Log.d("SecondActivity", "User Name: $userName, Age: $userAge")
    }
}
```

### Fragment ê°„ ë°ì´í„° ì „ë‹¬

- Fragment ê°„ ë°ì´í„° ì „ë‹¬ì—ë„ Bundle ì‚¬ìš© ê°€ëŠ¥

```kotlin
// ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ëŠ” Fragment
val fragment = SecondFragment().apply {
    arguments = Bundle().apply {
        putString("USER_NAME", "John Doe")
        putInt("USER_AGE", 25)
    }
}
parentFragmentManager.beginTransaction()
    .replace(R.id.fragment_container, fragment)
    .commit()

// ë°ì´í„°ë¥¼ ìˆ˜ì‹ í•˜ëŠ” Fragment
class SecondFragment : Fragment() {
    override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
        val view = inflater.inflate(R.layout.fragment_second, container, false)

        val userName = arguments?.getString("USER_NAME")
        val userAge = arguments?.getInt("USER_AGE")
        Log.d("SecondFragment", "User Name: $userName, Age: $userAge")

        return view
    }
}
```

#### Jetpack Navigation ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ Fragment ê°„ ë°ì´í„° ì „ë‹¬í•˜ê¸°

- [Jetpack Navigation](https://developer.android.com/guide/navigation) ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€
  ì§€ì›í•˜ëŠ” [Safe Args í”ŒëŸ¬ê·¸ì¸](https://developer.android.com/guide/navigation/use-graph/safe-args)ì„ ì‚¬ìš©í•˜ë©´ ëŒ€ìƒ ê°„ íƒ€ì…-ì„¸ì´í”„(type-safe)
  ë‚´ë¹„ê²Œì´ì…˜ê³¼ ì¸ìˆ˜ ì „ë‹¬ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ëŠ” direction ë° argument í´ë˜ìŠ¤ê°€ ì»´íŒŒì¼ íƒ€ì„ì— ìë™ì ìœ¼ë¡œ ìƒì„±ë˜ì–´, ëŸ°íƒ€ì„ ì‹œ ê°’ì„ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.
- í•˜ì§€ë§Œ Safe Args í”ŒëŸ¬ê·¸ì¸ì€ Android Viewì™€ Fragmentì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.
- ComposeëŠ” [type safe navigation](https://developer.android.com/guide/navigation/design/type-safety)ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

**1. ë‚´ë¹„ê²Œì´ì…˜ ê·¸ë˜í”„ì—ì„œ ì¸ìˆ˜(argument) ì •ì˜í•˜ê¸°**

```xml
<!-- navigation.xml -->
<fragment
        android:id="@+id/secondFragment"
        android:name="com.example.SecondFragment">
    <argument
            android:name="username"
            app:argType="string"/>
</fragment>
```

**2. ì†ŒìŠ¤ í”„ë˜ê·¸ë¨¼íŠ¸ì—ì„œ ë°ì´í„° ì „ë‹¬í•˜ê¸°**<br>
Safe Args í”ŒëŸ¬ê·¸ì¸ì€ ì»´íŒŒì¼ íƒ€ì„ì— ëŒ€ìƒ ê°ì²´ì™€ ë¹Œë” í´ë˜ìŠ¤ë¥¼ ìƒì„±í•˜ì—¬, ì¸ìˆ˜ë¥¼ ì•ˆì „í•˜ê³  ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.

```kotlin
val action = FirstFragmentDirections
    .actionFirstFragmentToSecondFragment(username = "skydoves")
findNavController().navigate(action)
```

**3. ëŒ€ìƒ í”„ë˜ê·¸ë¨¼íŠ¸ì—ì„œ ë°ì´í„° ê²€ìƒ‰í•˜ê¸°**<br>
ë§ˆì§€ë§‰ìœ¼ë¡œ, ì•„ë˜ ì½”ë“œì™€ ê°™ì´ ì „ë‹¬ëœ ì¸ìˆ˜ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.

```kotlin
val username = arguments?.let {
    SecondFragmentArgs.fromBundle(it).username
}
```

- Safe Argsë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ì˜ëœ ì¸ìˆ˜ë¥¼ ì»´íŒŒì¼ íƒ€ì„ì— ê²€ì‚¬í•˜ì—¬ ì •ì ì¸ ì½”ë“œë¡œ ë§Œë“¤ê³ , ëŸ°íƒ€ì„ì— í•´ë‹¹ ì¸ìˆ˜ ê°’ì„ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜´ìœ¼ë¡œì¨ ëŸ°íƒ€ì„ ì˜¤ë¥˜ë¥¼ ì¤„ì¼ ìˆ˜ ìˆë‹¤.
- í”ŒëŸ¬ê·¸ì¸ì—ì„œ ê·œì •í•˜ëŠ” ì»¨ë²¤ì…˜ì„ í†µí•˜ì—¬ í´ë˜ìŠ¤ ë° ë©”ì„œë“œë¥¼ ìƒì„±í•´ ì£¼ê¸° ë•Œë¬¸ì—, Fragment ê°„ì˜ ë°ì´í„° í•¸ë“¤ë§ ì½”ë“œì˜ ê°€ë…ì„± í–¥ìƒ

#### SharedViewModel ì‚¬ìš©í•˜ê¸°

- ë™ì¼í•œ Activity ë‚´ì—ì„œ Fragment ë¼ë¦¬ í†µì‹ í•´ì•¼ í•˜ëŠ”
  ê²½ìš° [Shared ViewModel](https://developer.android.com/guide/fragments/communicate#fragments)ì„ ê³ ë ¤í•´ ë³¼ ìˆ˜ ìˆë‹¤.
- Shared ViewModelì€ ë™ì¼í•œ Activity ë‚´ì˜ ì—¬ëŸ¬ Fragment ê°„ì— ê³µìœ ë˜ëŠ” ViewModel ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì˜ë¯¸
- Jetpackì˜ androidx.fragment:fragment-ktx íŒ¨í‚¤ì§€ì—ì„œ ì œê³µí•˜ëŠ” activityViewModels() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬í˜„ ê°€ëŠ¥
- activityViewModels() ë©”ì„œë“œëŠ” ViewModelì˜ ë²”ìœ„ë¥¼ Activityë¡œ ì§€ì •í•˜ì—¬ Fragmentê°€ ë™ì¼í•œ ViewModel ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ê·¼í•˜ê³  ê³µìœ í•  ìˆ˜ ìˆë‹¤.

```kotlin
// Shared ViewModel
class SharedViewModel : ViewModel() {

    private val _userData = MutableStateFlow<User?>(null)
    val userData: StateFlow<User?> get() = _userData

    fun setUserData(user: User) {
        _userData.value = user
    }
}

// Fragment A (ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” Fragment)
class FirstFragment : Fragment() {
    private val sharedViewModel: SharedViewModel by activityViewModels()

    fun updateUser(user: User) {
        sharedViewModel.setUserData(user)
    }
}

// Fragment B (ë°ì´í„°ë¥¼ ìˆ˜ì‹ í•˜ëŠ” Fragment)
class SecondFragment : Fragment() {
    private val sharedViewModel: SharedViewModel by activityViewModels()

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        lifecycleScope.launch {
            viewLifecycleOwner.repeatOnLifecycle(Lifecycle.State.RESUMED) {
                sharedViewModel.userData.collectLatest { user ->
                    // ..
                }
            }
        }
    }
}

// Activity (Activityì—ì„œ ë°ì´í„° ìˆ˜ì‹ í•˜ê¸°)
class MainActivity : ComponentActivity() {
    private val sharedViewModel: SharedViewModel by viewModels()

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        lifecycleScope.launch {
            lifecycle.repeatOnLifecycle(Lifecycle.State.RESUMED) {
                sharedViewModel.userData.collectLatest { user ->
                    // ..
                }
            }
        }
    }
}
```

### ì‹¤ì „ ì§ˆë¬¸

Q) ë™ì¼í•œ Activity ë‚´ì—ì„œ Fragment ê°„ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ì„ ë•Œ ì–´ë–¤ ë°©ë²•ì´ íš¨ê³¼ì ì¸ì§€ ì„¤ëª…í•´ ì£¼ì‹œê³ , ViewModelì„ í™œìš©í•œë‹¤ë©´ Bundleì´ë‚˜ ì§ì ‘ì ì¸ Fragment íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒê³¼
ë¹„êµí–ˆì„ ë•Œ ì–´ë–¤ ì´ì ì´ ìˆë‚˜ìš”?<br>
A) Shared ViewModelì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ íš¨ê³¼ì ì…ë‹ˆë‹¤.
ViewModelì€ êµ¬ì„± ë³€ê²½ ì‹œì—ë„ ë°ì´í„°ë¥¼ ìœ ì§€í•˜ë¯€ë¡œ onSaveInstanceState()ë‚˜ Bundleì„ í†µí•´ ì¼ì¼ì´ ìƒíƒœë¥¼ ì €ì¥í•˜ê³  ë³µì›í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
Bundleì´ë‚˜ ì§ì ‘ì ì¸ Fragment íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, Fragment ê°„ì˜ ì˜ì¡´ì„±ì´ ìƒê¸¸ ìˆ˜ ìˆì–´ ì½”ë“œê°€ ë³µì¡í•´ì§ˆ ìˆ˜ ìˆì§€ë§Œ,
Shared ViewModelì€ Fragment ê°„ì˜ ì˜ì¡´ì„± ì—†ì´ ë°ì´í„°ë¥¼ ê³µìœ í•˜ë¯€ë¡œ êµ¬ì¡°ê°€ ë” ê¹”ë”í•´ì§‘ë‹ˆë‹¤.

### ğŸ’¡ Pro Tips for Mastery: Fragment Result API

- Fragmentì—ì„œ ë‹¤ë¥¸ Fragment í˜¹ì€ Activity ê°„ì— ì¼íšŒì„±ìœ¼ë¡œ ê°’ì„ ì „ë‹¬í•´ì•¼ í•  ë•Œ ì‚¬ìš©
- ê°€ë ¹, QR ì½”ë“œ ìŠ¤ìº”ì„ ìˆ˜í–‰í•˜ëŠ” Fragmentê°€ ìŠ¤ìº”ëœ ë°ì´í„°ë¥¼ ì´ì „ì˜ Fragmentë¡œ ë‹¤ì‹œ ë³´ë‚´ì•¼ í•˜ëŠ” ìƒí™©ì¼ ë•Œ ìœ ìš© (A -> B -> A í˜•íƒœì˜ í™”ë©´ ì´ë™)
- [Fragment ë²„ì „ 1.3.0](https://developer.android.com/jetpack/androidx/releases/fragment#1.3.0) ì´ìƒì—ì„œëŠ” ê° FragmentManagerê°€
  FragmentResultOwnerë¥¼ êµ¬í˜„í•˜ì—¬, Fragmentê°€ ì„œë¡œ ì§ì ‘ ì°¸ì¡°í•  í•„ìš” ì—†ì´ ê²°ê³¼ ë¦¬ìŠ¤ë„ˆë¥¼ í†µí•´ í†µì‹  ê°€ëŠ¥
- ì´ëŠ” ë°ì´í„° ì „ë‹¬ì„ ë‹¨ìˆœí™”í•˜ë©´ì„œ ëŠìŠ¨í•œ ê²°í•©(loose coupling) ì„ ìœ ì§€í•©ë‹ˆë‹¤.

#### ë°©ë²•

1. Fragment A(ê²°ê³¼ë¥¼ ë°›ëŠ” í”„ë˜ê·¸ë¨¼íŠ¸)ì—ì„œ ê²°ê³¼ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
2. Fragment Bì—ì„œ ë™ì¼í•œ requestKeyë¥¼ ì‚¬ìš©í•˜ì—¬ ê²°ê³¼ ì „ë‹¬

#### Fragment Aì—ì„œ ê²°ê³¼ ë¦¬ìŠ¤ë„ˆ ì„¤ì •í•˜ê¸°

```kotlin
class FragmentA : Fragment() {

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // ë°ì´í„°ë¥¼ ìˆ˜ì‹ í•˜ê¸° ìœ„í•´ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        parentFragmentManager.setFragmentResultListener("requestKey", this) { requestKey, bundle ->
            val result = bundle.getString("bundleKey")
            // ìˆ˜ì‹ í•œ ê²°ê³¼ ê°’ ì²˜ë¦¬
        }
    }
}
```

`setFragmentResultListener("requestKey",...)`ëŠ” ê³ ìœ í•œ í‚¤ ê°’ì„ ì‚¬ìš©í•˜ì—¬ ë¦¬ìŠ¤ë„ˆë¥¼ ë“±ë¡í•˜ì—¬ ì—¬ëŸ¬ ê°œì˜ ë¦¬ìŠ¤ë„ˆê°€ ë“±ë¡ëœ ê²½ìš° êµ¬ë¶„ì´ ìš©ì´í•´ì§„ë‹¤.
ëª¨ë“  ì½œë°±ë“¤ì€ Fragmentê°€ STARTED ìƒíƒœì— ë“¤ì–´ê°ˆ ë•Œ ì‹¤í–‰ëœë‹¤.

#### Fragment Bì—ì„œ ê²°ê³¼ ë³´ë‚´ê¸°

```kotlin
class FragmentB : Fragment() {

    private lateinit var button: Button

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)

        button = view.findViewById(R.id.button)
        button.setOnClickListener {
            val result = "result"
            // ê°’ì„ Fragment Aë¡œ ì „ë‹¬
            parentFragmentManager.setFragmentResult("requestKey", bundleOf("bundleKey" to result))
        }
    }
}
```

- `setFragmentResult("requestKey", bundleOf("bundleKey" to result))`ëŠ” ê³ ìœ í•œ í‚¤ ê°’ë¥¼ ì‚¬ìš©í•˜ì—¬ FragmentManagerì— ì „ë‹¬í•  ê°’ì„ ì €ì¥
- Fragment Aê°€ í™œì„± ìƒíƒœê°€ ì•„ë‹ˆë¼ë©´, Fragment Aê°€ ì¬ê°œë˜ê³  ë¦¬ìŠ¤ë„ˆë¥¼ ë“±ë¡í•  ë•Œê¹Œì§€ ê°’ì€ ê³„ì† ì €ì¥ë˜ì–´ ìˆë‹¤. (ê²°ê³¼ê°’ì´ ì•ˆì „í•˜ê²Œ ë³´ì¡´)

#### Fragment Result APIì˜ ë™ì‘

- í‚¤-ë¦¬ìŠ¤ë„ˆì˜ 1:1 ê´€ê³„: ê° í‚¤ëŠ” í•œ ë²ˆì— í•˜ë‚˜ì˜ ë¦¬ìŠ¤ë„ˆì™€ í•˜ë‚˜ì˜ ê²°ê³¼ ê°€ì§ˆ ìˆ˜ ìˆë‹¤.
- ë³´ë¥˜ ì¤‘ì¸ ê²°ê³¼ëŠ” ë®ì–´ì“°ì—¬ì§: ë¦¬ìŠ¤ë„ˆê°€ í™œì„±í™”ë˜ê¸° ì „ì— ì—¬ëŸ¬ ê²°ê³¼ê°€ ì„¤ì •ë˜ë©´ ìµœì‹  ê²°ê³¼ë§Œ ì €ì¥
- ê²°ê³¼ëŠ” ì†Œë¹„ í›„ ì‚­ì œë¨: Fragmentê°€ ê²°ê³¼ë¥¼ ìˆ˜ì‹ í•˜ê³  ì²˜ë¦¬í•˜ë©´ ê²°ê³¼ëŠ” FragmentManagerì—ì„œ ì œê±°
- ë°± ìŠ¤íƒì˜ í”„ë˜ê·¸ë¨¼íŠ¸ëŠ” ê²°ê³¼ë¥¼ ë°›ì§€ ëª»í•¨: FragmentëŠ” ê²°ê³¼ë¥¼ ë°›ìœ¼ë ¤ë©´ ë°± ìŠ¤íƒì—ì„œ íŒ(pop)ë˜ê³  STARTED ìƒíƒœì—¬ì•¼ í•œë‹¤.
- STARTED ìƒíƒœì˜ ë¦¬ìŠ¤ë„ˆëŠ” ì¦‰ì‹œ íŠ¸ë¦¬ê±°ë¨: Fragment Bê°€ ê²°ê³¼ë¥¼ ì„¤ì •í•  ë•Œ Fragment Aê°€ ì´ë¯¸ í™œì„± ìƒíƒœì´ë©´ ë¦¬ìŠ¤ë„ˆëŠ” ì¦‰ì‹œ ì‹¤í–‰ëœë‹¤.
